{% extends "base.html" %}

{% block content %}

<script>
/*
* User list auto complete
*/
$.widget("custom.user_complete", $.ui.autocomplete, {
    _renderMenu: function(ul, items) {
        var self = this;
        $.each(items, function(index, item) {
            self._renderItem(ul, item);
        });
    }
});

function bindCollabActions(context) {
    $(".del-collab", context).bind('click', function() {
        var self = $(this);             // del-collab link
        var note_listing = self.parents(".note-listing");     // note listing container
        var collab = self.next();       // collab email container
        
        // send request to delete this collaborator
        $.ajax({
            type: "POST",
            url: "/ajax/del_collab",
            data: "note_id=" + note_listing.attr("data-id") + "&email=" + collab.html(),
            success: function(result) {
                json = $.parseJSON(result);
                if(json["status"] == "ok") {
                    // remove the elements corresponding to this collaborator
                    self.remove();
                    collab.remove();
                }
            },
            error: function(jqXHR, textStatus, error) {
                //debug.log(jqXHR);
            }
        });
        
    });
}

/*
* Adds html for specified collaborator and binds appropriate delete actions
*/
function addCollaborator(context, email) {
    $(".collaborators", context).append("<a class=\"del-collab\" href=\"#del-collab\">x</a><span class=\"collab\">" + email + "</span>");
    bindCollabActions(context);
}

$(function() {
    /*
    * Specify custom autocomplete method to display
    * users under input fields
    */ 
    $("input.add-collab").user_complete({
        source: function(request, response) {
            $.ajax({
                type: "GET",
                url: "/ajax/search_collab",
                data: "email=" + request.term,
                success: function(result) {
                    var json = $.parseJSON(result);
                    // call the custom response function, passing the
                    // items list in order to render items
                    response(json);
                },
                error: function(jqXHR, textStatus, error) {
                    //debug.log(jqXHR);
                }
            });
        },
        select: function(event, ui) {
        }
    }).data("user_complete")._renderItem = function(ul, item) {
        return $("<li></li>")
                    .data("item.autocomplete", item)
                    .append($(""))
                    .append($("<a class='ui-menu-item'></a>")
                        .html(item.label))
                    .appendTo(ul);
    };
    
    /*
    * Bind the submit function to the input box
    */
    $("input.add-collab").bind('keypress', function(e) {
        var code = (e.keyCode ? e.keyCode : e.which);
        // make sure enter key pressed
        if(code != 13) return;
        
        var self = $(this);
        
        $.ajax({
            type: "POST",
            url: "/ajax/add_collab",
            data: "note_id=" + self.attr("data-note-id") + "&email=" + self.val(),
            success: function(result) {
                json = $.parseJSON(result);
                if(json["status"] == "ok") {
                    // add the collaborator name to ui, but only within the
                    // context of this input field's parent
                    addCollaborator(self.parent(), self.val());
                    self.val("");
                }
            },
            error: function(jqXHR, textStatus, error) {
                //debug.log(jqXHR);
            }
        });
        
    });
    
    // bind actions to all collaborators found on page
    bindCollabActions($(document));
});
</script>
<script type="text/javascript">
	function changeBackground(elem)
	{
		elem.style.backgroundColor = "#EFF5F9";
		elem.style.backgroundAttachment = "scroll";
		elem.style.backgroundClip = "border-box";

	}
	function changeBackgroundBack(elem)
	{
		elem.style.backgroundColor = "white";
	}
</script>

    <div id="content-wrap">
        <a id="create-note" href="/editor">+ Create New Note</a>
		<br/>
        {% if notes %}
        <p>Your notes:</a><br/>
		<ul id="notes">		
        {% for note in notes %}
            <li class="note-listing" data-id="{{ note.pk }}" onmouseover="changeBackground(this);" onmouseout="changeBackgroundBack(this);">
                <a class="view" href="/note/{{ note.pk }}">
                {% if not note.revisions %}Note {{ note.pk }}
                {% else %}{{ note.revisions.0.title }}{% endif %}
                </a><br />
				<div class="collaboration">
		            Collaborators:<br/>
		           <span class="collaborators">
                {% for collab in note.access_list %}
                    {% if collab != user %}
                        <a class="del-collab" href="#del-collab">x</a><span class="collab">{{ collab.email }}</span>
                    {% endif %}
                {% endfor %}
                </span>
		            Add a collaborator:<br/>
		            <input type="text" data-note-id="{{ note.pk }}" class="add-collab" />
				</div>
            </li>
        {% endfor %}
        {% endif %}
		</ul>
    </div>
{% endblock %}

{% block right-column %}
<div id="right-column">
</div>
{% endblock %}
