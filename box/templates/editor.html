{% extends "base.html" %}

{% block content %}
<script>
    // set the orbited settings and port
    
    //Orbited.settings.port = 9000;
    //Orbited.settings.hostname = "localhost";
    
    //Orbited.settings.streaming = false;
    TCPSocket = Orbited.TCPSocket;
    document.domain = document.domain;

    function add_message(msg) {
        $("<p>" + msg["message"] + "</p>").appendTo("#messages")
    };
    $(document).ready(function() {
        stomp = new STOMPClient();
        stomp.onopen = function(){
            //console.log("opening stomp client");
        };
        stomp.onclose = function(c){
            alert('Lost Connection, Code: ' + c);
        };
        stomp.onerror = function(error){
            alert("Error: " + error);
        };
        stomp.onerrorframe = function(frame){
            alert("Error: " + frame.body);
        };
        stomp.onconnectedframe = function(){
            console.log("Connected. Subscribing");
            //alert("subscribing");
            var note_id = $("#save").attr("attr-note_id");
            stomp.subscribe("/messages-" + note_id);
        };
        stomp.onmessageframe = function(frame){
            // Presumably we should only receive message frames with the
            // destination "/topic/message" because that's the only destination
            // to which we've subscribed. To handle multiple destinations we
            // would have to check frame.headers.destination.
            add_message($.parseJSON(frame.body));
        };
        stomp.connect('localhost', 61613);

        $("#send").click(function(data) {
            var message = $("#message").val()
            var user = $("#user").val()
            $.post("/addMessage/", {"message":message, "user":user});
        })
    });
</script>
{% if not note %}
NOTE NOT FOUND
{% else %}
<div id="messages"></div>
<div>
<a href="#saving" id="save" attr-note_id="{{ note.pk }}">Save</a>
<br/>
Title:<br>
<input type="text" name="title" id="title-{{ note.pk }}" style="width:500px;" value="{{ note.title }}"/>
<div id="notes-button-bar"></div>
<textarea class="note-editor" id="notes-{{ note.pk }}" style="width:500px; height: 500px">{{ note.text }}</textarea>
<br />
Preview:
<div id="notes-preview"></div>
<br />
Output:
<textarea type="text" name="copy_html" value="" id="copy_html" style="width:500px; height: 500px"></textarea>
</div>

<script type="text/javascript">
$("#save").bind("click", function() {
    var note_id = $(this).attr("attr-note_id");
    var text = encodeURIComponent($("#notes-" + note_id).val());
    var title = encodeURIComponent($("#title-" + note_id).val());

    $("#save").html("Saving...");
    
    $.ajax({
        type: "POST",
        url: "/save_note",
        data: "note_id=" + note_id + "&text=" + text + "&title=" + title,
        success: function(result){
             //var json = $.parseJSON(result);
             //response(json);
             $("#save").html("Save");
             console.log(result);
        },
         error: function(jqXHR, textStatus, error){
             //console.log(jqXHR);
        }
    });
});
  new WMDEditor({
      input: "notes-{{ note.pk }}",
      button_bar: "notes-button-bar",
      preview: "notes-preview",
      output: "copy_html",
      buttons: "bold italic link ol ul heading code quote image",
      modifierKeys: false,
      autoFormatting: false,
  });
  $(function() {
     mobwrite.share('notes-{{ note.pk }}');
  });
</script>

{% endif %}
{% endblock %}